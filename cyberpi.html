<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <link rel="icon" type="image/png" sizes="512x512" href="srcs/comm/web_favicon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="srcs/comm/web_favicon.png">
    <link rel="stylesheet" href="styles.css">
    
</head>

<!-- Overlay de solución -->
<div id="solutionOverlay">
  <div class="solution-content">
    <img id="solutionImage" src="" alt="Challenge Solution">
  </div>
</div>

<body>
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const lvl = Number(params.get("lvl") || 0);
      const robot = location.pathname.toLowerCase().includes("mbot2") ? "mBot2" : "CyberPi";
      const key = `levelSession:${robot}:${lvl}`; // flag para permitir refresh

      // 1) Si ya hay flag, permitir recarga directa
      if (sessionStorage.getItem(key) === "1") {
        localStorage.setItem("selectedRobot", robot);
        return;
      }

      try {
        const ticketStr = sessionStorage.getItem("entryTicket");
        if (!ticketStr) throw new Error("no-ticket");

        const ticket = JSON.parse(ticketStr);
        const maxAgeMs = 15000; // tu ventana (15s). Si quieres, usa 5*60*1000 para 5min.
        const valid =
          ticket &&
          ticket.robot === robot &&
          Number(ticket.lvl) === lvl &&
          (Date.now() - Number(ticket.t)) < maxAgeMs;

        if (!valid) throw new Error("invalid-ticket");

        // 2) Consumir el ticket SOLO tras validar y habilitar refresh
        sessionStorage.removeItem("entryTicket");
        sessionStorage.setItem(key, "1");
        localStorage.setItem("selectedRobot", robot);
      } catch (e) {
        // Limpieza y regreso al index (selector)
        sessionStorage.removeItem("entryTicket");
        location.replace("index.html#home");
      }
    })();
  </script>

    <button class="home-btn" onclick="irHome()">↑</button>
    <div class="slide-counter"><span class="num-big" id="slide-number">01</span>/<span id="slide-total">01</span></div>
    <div class="image-center" id="slide-media-container"></div>
    <button class="prev-btn" onclick="accionPrev()">←</button>
    <button class="next-btn" onclick="accionNext()">→</button>
    <button id="solnBtn" class="button">Solution</button>
    <div class="info-box">
        <div id="slide-text">Text.</div>
    </div>
    <script src="cyberpi/cyberpi_script.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc} from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyB5G4RxthuaADgJg1-xuJCtR_oOOYrBals",
          authDomain: "lsrobotics-78127.firebaseapp.com",
          projectId: "lsrobotics-78127",
          storageBucket: "lsrobotics-78127.firebasestorage.app",
          messagingSenderId: "32125955765",
          appId: "1:32125955765:web:7ee8712982da4005c558fc"
        };
      
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
      
        async function registrarAccion(accion) {
          const user = auth.currentUser;
          if (!user) return;
      
          const urlParams = new URLSearchParams(window.location.search);
          const actividad = urlParams.get("lvl") || "desconocida";
          const robot = localStorage.getItem("selectedRobot") || "desconocido";
      
          try {
            await addDoc(collection(db, "acciones"), {
              uid: user.uid,
              accion,
              timestamp: serverTimestamp(),
              actividad,
              diapositiva: currentSlide || 0,
              robot
            });
          } catch (e) {
            console.error("Register error:", e);
          }
        }

        async function checkAdminSolution(auth, db) {
          const user = auth.currentUser;
          const solnBtn = document.getElementById("solnBtn");

          if (!user) {
              solnBtn.style.display = "none";
              window.isAdmin = false;
              return;
          }

          try {
              const ref = doc(db, "usuarios", user.uid);
              const snap = await getDoc(ref);
              window.isAdmin = !!snap.data()?.admin;

              if (!window.isAdmin) {
                  solnBtn.style.display = "none";
              }
              
          } catch (e) {
              console.warn("No pude verificar rol admin:", e);
              window.isAdmin = false;
              solnBtn.style.display = "none";
          }

          if (window.updateSlide) window.updateSlide();
        }
      
        window.registrarAccion = registrarAccion;
      
        onAuthStateChanged(auth, async(user) => {
            if (!user && location.hostname === "localhost") {
                console.warn("Not authenticated");
                return;
            }

            if (user) {
                registrarAccion("start");
                await checkAdminSolution(auth, db);
            }
        });
      </script>      
</body>
</html>