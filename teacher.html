<!DOCTYPE html>
<html>
<head>
    <title>Panel del Profesor</title>
    <link rel="icon" type="image/png" sizes="512x512" href="srcs/comm/web_favicon.png">
    <link rel="apple-touch-icon" sizes="512x512" href="srcs/comm/web_favicon.png">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc, getDocs, where, orderBy, Timestamp, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5G4RxthuaADgJg1-xuJCtR_oOOYrBals",
            authDomain: "lsrobotics-78127.firebaseapp.com",
            projectId: "lsrobotics-78127",
            storageBucket: "lsrobotics-78127.firebasestorage.app",
            messagingSenderId: "32125955765",
            appId: "1:32125955765:web:7ee8712982da4005c558fc"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        onAuthStateChanged(auth, async user => {
            const statusEl = document.getElementById("status");
            const gatedIds = ["configNiveles", "graficoContenedor", "filtros"];

            const showGated = (show) => {
                gatedIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = show ? "" : "none";
                });
            };

            if (!user) {
                // No hay sesión: muestra mensaje abajo y oculta paneles
                statusEl.textContent = "No estás logeado.";
                showGated(false);
                homeBtn.style.display = "none";
                return;
            }

            // Hay sesión: verificamos admin
            const docRef = doc(db, "usuarios", user.uid);
            const userSnap = await getDoc(docRef);

            if (userSnap.exists() && userSnap.data().admin === true) {
                const firstName = (user.displayName || "").split(" ")[0] || "Teacher";
                statusEl.textContent = `Welcome back, ${firstName}!`;
                showGated(true);
                homeBtn.style.display = "block";
                await cargarNombres();
                filtrarYGraficar();
                initNivelesUI();
            } else {
                // Sin permisos: no alert, no popup, solo mensaje y panel oculto
                statusEl.textContent = "No tienes permisos de administrador.";
                showGated(false);
                homeBtn.style.display = "none";
                // si quieres forzar salida para volver a intentar con otra cuenta:
                // await auth.signOut();
            }
        });



        let mapaNombres = {}; // uid → nombre

        async function cargarNombres() {
        const usuariosSnap = await getDocs(collection(db, "usuarios"));
        usuariosSnap.forEach(doc => {
            const data = doc.data();
            mapaNombres[doc.id] = data.nombre || doc.id; // usa uid si no hay nombre
        });
        }

        /*function cargarDatos() {
        const q = query(collection(db, "acciones")); // acciones = tu colección de eventos
        onSnapshot(q, (querySnapshot) => {
            const container = document.getElementById("datos");
            container.innerHTML = "";
            querySnapshot.forEach((doc) => {
            const data = doc.data();
            const p = document.createElement("p");
            //p.textContent = JSON.stringify(data);
            //p.textContent = `${data.uid} → ${data.accion} en ${data.actividad} (${data.robot}) - ${new Date(data.timestamp?.seconds * 1000).toLocaleString()}`;
            p.innerHTML = `
                <strong>${data.uid}</strong> → ${data.accion}<br>
                Actividad ${data.actividad}, Diapositiva ${data.diapositiva}<br>
                Robot: ${data.robot}<br>
                <em>${new Date(data.timestamp?.seconds * 1000).toLocaleString()}</em>
                `;
            container.appendChild(p);
            });
        });
        }*/
        let unsubscribe = null;
        let chart = null;
        function filtrarYGraficar() {
            const fechaInput = document.getElementById("fecha").value;
            const desdeHora = document.getElementById("desde").value;
            const hastaHora = document.getElementById("hasta").value;
            const actividadFiltro = document.getElementById("actividadFiltro").value;
            const homeBtn = document.getElementById("homeBtn");

            if (!fechaInput) {
                alert("Por favor selecciona una fecha.");
                return;
            }

            const [year, month, day] = fechaInput.split("-").map(Number);
            const [dH, dM] = desdeHora.split(":").map(Number);
            const [hH, hM] = hastaHora.split(":").map(Number);

            const desde = new Date(year, month - 1, day, dH, dM);
            const hasta = new Date(year, month - 1, day, hH, hM);

            if (unsubscribe) unsubscribe();

            let filtros = [
            where("timestamp", ">=", Timestamp.fromDate(desde)),
            where("timestamp", "<=", Timestamp.fromDate(hasta)),
            orderBy("timestamp", "asc")
            ];

            if (actividadFiltro) {
            filtros.push(where("actividad", "==", actividadFiltro));
            }

            const q = query(collection(db, "acciones"), ...filtros);

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const datosPorUID = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const ts = data.timestamp?.seconds;
                    if (!ts) return;

                    const uid = data.uid;
                    if (!datosPorUID[uid]) datosPorUID[uid] = [];

                    datosPorUID[uid].push({
                        x: new Date(ts * 1000),
                        y: data.diapositiva || 0
                    });
                });

                const datasets = Object.entries(datosPorUID).map(([uid, puntos], i) => ({
                    label: mapaNombres[uid] || uid,
                    data: puntos.sort((a, b) => a.x - b.x),
                    borderColor: `hsl(${i * 50}, 70%, 50%)`,
                    fill: false,
                    tension: 0.1
                }));

                if (chart) chart.destroy();

                const ctx = document.getElementById('graficoAvance').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        scales: {
                            x: { type: 'time', time: { unit: 'minute' }, min: desde, max: hasta, title: { display: true, text: 'Hour' } },
                            y: { title: { display: true, text: 'Slide' }, beginAtZero: true, max: 25 }
                        },
                        maintainAspectRatio: false
                    }
                });

                chart.update();
            });
        }
        window.filtrarYGraficar = filtrarYGraficar;

        function initNivelesUI(){
            subscribeRobot("mBot2", "cfg-mbot2");
            subscribeRobot("CyberPi", "cfg-cyberpi");
        }

        function subscribeRobot(robot, containerId){
        const cont = document.getElementById(containerId);
        const q = query(collection(db,"niveles"), where("robot","==",robot), orderBy("nivel","asc"));

        // Guardamos docId por nivel para actualizar
        const idPorNivel = new Map();

        onSnapshot(q, (snap)=>{
            const html = [];
            idPorNivel.clear();

            snap.forEach(d=>{
            const data = d.data();
            idPorNivel.set(data.nivel, d.id);
            html.push(`
                <label class="nivel-toggle" data-nivel="${data.nivel}">
                    <span>${data.nivel}</span>
                    <input type="checkbox" ${data.enabled ? "checked": ""}/>
                </label>
            `);
            });

            cont.innerHTML = html.join("");

            // Eventos de cambio
            cont.querySelectorAll(".nivel-toggle input[type='checkbox']").forEach(chk=>{
            chk.addEventListener("change", async (e)=>{
                const wrap = e.target.closest(".nivel-toggle");
                const nivel = Number(wrap.dataset.nivel);
                const docId = idPorNivel.get(nivel);
                try{
                wrap.classList.add("pending");
                await updateDoc(doc(db,"niveles",docId), {
                    enabled: e.target.checked,
                    updatedAt: serverTimestamp(),
                    updatedBy: auth.currentUser?.uid || null
                });
                }catch(err){
                console.error(err);
                e.target.checked = !e.target.checked; // revertir
                alert("No se pudo actualizar el nivel.");
                }finally{
                wrap.classList.remove("pending");
                }
            });
            });
        });
        }

        homeBtn.addEventListener("click", () => {
            sessionStorage.setItem("skipWelcome", "1");
            location.href = "index.html#home";
        });
    </script>
</head>
<body>
    <button id="homeBtn" class="home-btn" style="display:nosne" aria-label="Back">↑</button>
    <h1>Teacher dashboard</h1>
    <div id="datos"></div>
    <div id="graficoContenedor">
        <canvas id="graficoAvance"></canvas>
    </div>
    <div id="filtros">
        <label>Date: <input type="date" id="fecha" value=""></label>
        <label>From: <input type="time" id="desde" value="08:00"></label>
        <label>To: <input type="time" id="hasta" value="09:00"></label>
        <label>Activity:
            <select id="actividadFiltro">
                <option value="">All</option>
                <option value="1">Act 1</option>
                <option value="2">Act 2</option>
                <option value="3">Act 3</option>
                <option value="4">Act 4</option>
                <option value="5">Act 5</option>
                <option value="6">Act 6</option>
                <option value="7">Act 7</option>
                <option value="8">Act 8</option>
            </select>
        </label>
        <button onclick="filtrarYGraficar()">Filtrar</button>
    </div>
    <p id="status">Verificando acceso...</p>
    <div id="configNiveles" style="max-width:1100px;margin:1rem auto;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <section class="card" style="padding:12px;border:1px solid #e5e5e5;border-radius:12px;">
        <h3 style="margin:0 0 8px;">mBot2</h3>
        <div id="cfg-mbot2" class="niveles-grid"></div>
        </section>
        <section class="card" style="padding:12px;border:1px solid #e5e5e5;border-radius:12px;">
        <h3 style="margin:0 0 8px;">CyberPi</h3>
        <div id="cfg-cyberpi" class="niveles-grid"></div>
        </section>
    </div>
    </div>
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const hoy = new Date();
        const yyyy = hoy.getFullYear();
        const mm = String(hoy.getMonth() + 1).padStart(2, '0');
        const dd = String(hoy.getDate()).padStart(2, '0');
        document.getElementById("fecha").value = `${yyyy}-${mm}-${dd}`;
    });
    </script>
    <style>
    #pantallaNegra {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: white;
    }
    </style>
    <div id="pantallaNegra"></div>
    <script>
    let oculto = false;
    window.addEventListener("keydown", (e) => {
        if (e.code === "Space") {
        oculto = !oculto;
        document.getElementById("pantallaNegra").style.display = oculto ? "block" : "none";
        }
    });
    </script>
</body>
</html>
